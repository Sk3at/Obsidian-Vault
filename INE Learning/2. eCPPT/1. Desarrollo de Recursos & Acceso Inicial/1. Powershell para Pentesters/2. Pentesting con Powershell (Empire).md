Powershell-Empire (Aka Empire) es un marco de trabajo de powershell para explotacion/post-explotacion construido sobre comunicaciones seguras encriptadas y con una arquitectura flexible.
Empire implementa la habilidad de correr agentes de powershell sin la necesidad de powershell.exe, da la posibilidad de lanzar modulos de post explotacion desde keyloggers hasta mimikatz, y contiene comunicaciones adaptables para evadir detecciones de red, todo junto dentro del marco de trabajo enfocado en la usabilidad.
Recientemente fue actualizado y ahora es parte del soporte oficial mantenido por Kali.
En ciertos puntos es similar al framework de Metasploit, con la principal diferencia que Empire se utiliza para la explotacion y post explotacion para sistemas Windows especialmente.
Es un marco avanzado y se ve como un servidor C2 (command and control).
Podemos encontrar la documentacion de Empire en el siguiente link: https://bc-security.gitbook.io/empire-wiki

LABORATORIO
Se nos da la tarea por una organizacion de realizar un penetration test. Se supone que la maquina que esta frente a la conexion de internet se encuentra en el dominio demo.ine.local y se nos informa que existe otra maquina en el dominio fileserver.ine.local la cual no es accesible de forma directa.
Debemos realizar la explotacion remota en el sistema vulnerable para ganar acceso a ambas maquinas y obtener la flag.

SOLUCION
Una vez dentro de nuestra VM abrimos la terminal y revisamos si se encuentra configurado el dominio demo.ine.local en el archivo /etc/hosts
![](../../Images/Pasted%20image%2020240403191541.png)
Ahoa que sabemos la direccion IP del mismo procedemos a lanzarle un ping para verificar que responde solicitudes ICMP. Para ello creamos una variable de entorno llamada target con el valor de la direccion IP de la victima y luego realizamos un ping utilizando la variable.
![](../../Images/Pasted%20image%2020240403191924.png)
Como se observa, el TTL de respuesta del ICMP es de 125 lo que corresponderia a una maquina Windows. El siguiente paso es realizar un escaneo de puertos para verificar cuales son los puertos abiertos en nuestra maquina victima.
![](../../Images/Pasted%20image%2020240403192232.png)
Con este comando estamos diciendo que queremos realizar un escaneo en los 65mil puertos, verificar unicamente los que se encuentren abiertos y luego utilizamos algunas opciones para que la verificacion sea rapida y lo menos intrusiva posible.
- -sS SYN SCAN
- -n NO DNS
- -Pn NO PING
- --min-rate 5000 NO MENOS DE 5000 PQTS POR SEGUNDO
En tan solo 12 segundos obtenemos la informacion de los puertos abiertos en la maquina victima ![](../../Images/Pasted%20image%2020240403192545.png)
Ahora debemos realizar un segundo escaneo para intentar ver que servicios y versiones se ejecutan en estos puertos abiertos.
![](../../Images/Pasted%20image%2020240403193023.png)
![](../../Images/Pasted%20image%2020240403193006.png)
Lo que vemos es que tenemos en ejecucion SMB, RDP y dos servidores web en los puertos superiores. Vamos a verificar primero los servidores web en busqueda de algo que nos sea interesante.
![](../../Images/Pasted%20image%2020240403193600.png)
Al realizar un curl al puerto 4983 vemos un mensaje de lo que parecen ser las credenciales de SMB del administrador. Por lo que podemos intentar conectarnos con estas credenciales por medio de smbexec.
Para ello utilizamos el siguiente comando:
smbexec.py 'Administrator:abc_123321!@#'@demo.ine.local
![](../../Images/Pasted%20image%2020240405230233.png)
Ahora revisamos las interfaces de red.
![](../../Images/Pasted%20image%2020240405230316.png)
Con esta subnet podemos llegar al otro dominio que tiene la IP 10.4.25.24
![](../../Images/Pasted%20image%2020240405230426.png)
Lo que significa que podemos atacar fileserver.ine.local utilizando esta maquina como pivot.
Nuestra proxima tarea es obtener esta conexion a travez de un listener de Empire, por lo que iniciamos Empire Server.
![](../../Images/Pasted%20image%2020240405230733.png)
Ahora iniciamos el cliente con powershell-empire client
![](../../Images/Pasted%20image%2020240405230921.png)
Ahora debemos configurar el listener con uselistener http y setear sus opciones
![](../../Images/Pasted%20image%2020240405231201.png)
![](../../Images/Pasted%20image%2020240405231209.png)
![](../../Images/Pasted%20image%2020240405231228.png)
Ahora debemos crear un stager para nuestro objetivo, esto lo haremos volviendo al menu escribiendo main.
![](../../Images/Pasted%20image%2020240405231442.png)
Seteamos el Listener como HTTP
![](../../Images/Pasted%20image%2020240405231516.png)
Y corremos execute para que nos genere el payload para powershell encodeado, esto lo pegaremos como un comando en nuestra sesion de smbexec que tenemos abierta en el objetivo.
![](../../Images/Pasted%20image%2020240405231544.png)
Una vez realizado recibiremos la conexion tanto con nuestro cliente como servidor.
![](../../Images/Pasted%20image%2020240405231800.png)
![](../../Images/Pasted%20image%2020240405231809.png)
Incluso en el cliente veremos en la parte inferior que se encuentra conectado un agente
![](../../Images/Pasted%20image%2020240405231848.png)
Esto podemos confirmarlo ejecutando agents en el cliente
![](../../Images/Pasted%20image%2020240405231928.png)
Para interactuar con el mismo debemos usar el comando interact con el nombre del agente
![](../../Images/Pasted%20image%2020240405232039.png)
Ahora podemos utilizar algunos modulos de post explotacion, como uno para obtener informacion del sistema.
![](../../Images/Pasted%20image%2020240405232224.png)
![](../../Images/Pasted%20image%2020240405232306.png)
Ahora podemos utilizar un modulo de portscan para escanear la IP de fileserver
![](../../Images/Pasted%20image%2020240405232418.png)
Seteamos el host y ejecutamos
![](../../Images/Pasted%20image%2020240405232522.png)
Luego de unos segundos recibimos los resultados
![](../../Images/Pasted%20image%2020240405232552.png)
Ya que ahora sabemos que puertos se encuentran abiertos en la maquina objetivo vamos a realizar el pivoting, para ello utilizaremos Metasploit, por lo que debemos transferir nuestro agente a Metasploit, para ello podemos utilizar el modulo de empire "invoke_metasploitpayload", este miodulo nos permite ejecutar un payload de metasploit que nos permitira enviar nuestro agente a un listener de msf.
Primero debemos crear nuestro payload en metasploit, para ello utilizaremos el modulo web_delivery, lo que nos permite generar un payload de poweshell por URL.
![](../../Images/Pasted%20image%2020240405233201.png)
Ahora configuramos el exploit
![](../../Images/Pasted%20image%2020240405233228.png)
![](../../Images/Pasted%20image%2020240405233422.png)
Ahora ejecutamos y se nos generara el payload para utilizar en el agente.
![](../../Images/Pasted%20image%2020240405233508.png)
Ahora en empire client vamos a utilizar el siguiente modulo
![](../../Images/Pasted%20image%2020240405233621.png)
Ahora realizamos un set URL con el valor que nos brindo metasploit
![](../../Images/Pasted%20image%2020240405233724.png)
Ejecutamos para obtener la conexion en msf.
![](../../Images/Pasted%20image%2020240405233853.png)
![](../../Images/Pasted%20image%2020240405234306.png)
Ahora aplicamos el autoroute
![](../../Images/Pasted%20image%2020240405234413.png)
Ahora que tenemos la ruta agregada podemos utilizar el modulo socks_proxu para realizar reconocmiento adicional.
![](../../Images/Pasted%20image%2020240405234601.png)
En firefox debemos tambien configurar el proxy
![](../../Images/Pasted%20image%2020240405234734.png)
Al visitar fileserver.ine.local vemos un badblue
![](../../Images/Pasted%20image%2020240405234841.png)
Ahora podemos buscar el exploit en msf
![](../../Images/Pasted%20image%2020240405235011.png)
Una vez configurado ejecutamos y asi estaremos dentro del la maquina final.
![](../../Images/Pasted%20image%2020240405235158.png)
![](../../Images/Pasted%20image%2020240405235223.png)
![](../../Images/Pasted%20image%2020240405235243.png)
